@page "/price-calculator"
@using System.Net.Http.Json
@using System.Text.Json
@inject HttpClient HttpClient
@inject IConfiguration Configuration
@rendermode InteractiveServer

<PageTitle>Azure Price Calculator</PageTitle>

<h1>Azure Price Calculator</h1>

<p>Estimate costs for your Azure architecture by uploading a diagram or manually entering resources.</p>

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>Step 1: Input Resources</h3>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab">
                                Manual Entry
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="diagram-tab" data-bs-toggle="tab" data-bs-target="#diagram" type="button" role="tab">
                                Upload Diagram
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3">
                        <div class="tab-pane fade show active" id="manual" role="tabpanel">
                            <EditForm Model="@newResource" OnValidSubmit="@AddResource">
                                <div class="mb-3">
                                    <label class="form-label">Service Name</label>
                                    <InputSelect @bind-Value="newResource.ServiceName" class="form-select">
                                        <option value="">Select a service...</option>
                                        <option value="Virtual Machines">Virtual Machines</option>
                                        <option value="Azure SQL Database">Azure SQL Database</option>
                                        <option value="Storage">Storage</option>
                                        <option value="Azure App Service">Azure App Service</option>
                                        <option value="Azure Kubernetes Service">Azure Kubernetes Service</option>
                                        <option value="Azure Functions">Azure Functions</option>
                                        <option value="Azure Cosmos DB">Azure Cosmos DB</option>
                                    </InputSelect>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">SKU Name</label>
                                    <InputText @bind-Value="newResource.SkuName" class="form-control" placeholder="e.g., Standard_D2s_v3" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Region</label>
                                    <InputSelect @bind-Value="newResource.Region" class="form-select">
                                        <option value="eastus">East US</option>
                                        <option value="westus">West US</option>
                                        <option value="westeurope">West Europe</option>
                                        <option value="northeurope">North Europe</option>
                                        <option value="southeastasia">Southeast Asia</option>
                                    </InputSelect>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Quantity</label>
                                    <InputNumber @bind-Value="newResource.Quantity" class="form-control" min="1" />
                                </div>
                                <button type="submit" class="btn btn-primary">Add Resource</button>
                            </EditForm>
                            
                            @if (resources.Any())
                            {
                                <div class="mt-4">
                                    <h5>Added Resources</h5>
                                    <div class="list-group">
                                        @foreach (var resource in resources)
                                        {
                                            <div class="list-group-item">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>@resource.ServiceName</strong> - @resource.SkuName
                                                        <br />
                                                        <small class="text-muted">Region: @resource.Region | Qty: @resource.Quantity</small>
                                                    </div>
                                                    <button class="btn btn-sm btn-danger" @onclick="() => RemoveResource(resource)">Remove</button>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                        
                        <div class="tab-pane fade" id="diagram" role="tabpanel">
                            <div class="alert alert-info">
                                <strong>Note:</strong> Diagram analysis feature requires Azure Computer Vision or GPT-4 Vision API configuration.
                                Currently showing example resources.
                            </div>
                            <button class="btn btn-secondary" @onclick="LoadExampleResources">Load Example Resources</button>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-success btn-lg w-100" @onclick="CalculatePricing" disabled="@(!resources.Any() || isLoading)">
                            @if (isLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span>Calculating...</span>
                            }
                            else
                            {
                                <span>Calculate Pricing</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>Step 2: Cost Estimate</h3>
                </div>
                <div class="card-body">
                    @if (errorMessage != null)
                    {
                        <div class="alert alert-danger">@errorMessage</div>
                    }
                    
                    @if (costResult != null)
                    {
                        <div class="alert alert-success">
                            <h4>Total Cost Summary</h4>
                            <table class="table table-borderless mb-0">
                                <tbody>
                                    <tr>
                                        <td><strong>Hourly:</strong></td>
                                        <td class="text-end"><strong>@costResult.Summary.TotalHourlyCost.ToString("C4") @costResult.Currency</strong></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Monthly:</strong></td>
                                        <td class="text-end"><strong>@costResult.Summary.TotalMonthlyCost.ToString("C2") @costResult.Currency</strong></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Yearly:</strong></td>
                                        <td class="text-end"><strong>@costResult.Summary.TotalYearlyCost.ToString("C2") @costResult.Currency</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <h5>Cost Breakdown by Resource</h5>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Resource</th>
                                        <th class="text-end">Qty</th>
                                        <th class="text-end">Monthly</th>
                                        <th class="text-end">Yearly</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in costResult.Breakdown)
                                    {
                                        <tr>
                                            <td>
                                                @item.Resource
                                                @if (!string.IsNullOrEmpty(item.Error))
                                                {
                                                    <br /><small class="text-danger">@item.Error</small>
                                                }
                                            </td>
                                            <td class="text-end">@item.Quantity</td>
                                            <td class="text-end">@item.MonthlyCost.ToString("C2")</td>
                                            <td class="text-end">@item.YearlyCost.ToString("C2")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <h6>Important Notes:</h6>
                            <ul>
                                @foreach (var note in costResult.Notes)
                                {
                                    <li><small>@note</small></li>
                                }
                            </ul>
                        </div>
                    }
                    else if (!isLoading)
                    {
                        <div class="text-center text-muted">
                            <p>Add resources and click "Calculate Pricing" to see cost estimates.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private AzureResource newResource = new();
    private List<AzureResource> resources = new();
    private CostCalculationResult? costResult;
    private bool isLoading = false;
    private string? errorMessage;

    private void AddResource()
    {
        if (!string.IsNullOrEmpty(newResource.ServiceName) && !string.IsNullOrEmpty(newResource.SkuName))
        {
            resources.Add(new AzureResource
            {
                ServiceName = newResource.ServiceName,
                SkuName = newResource.SkuName,
                Region = newResource.Region,
                Quantity = newResource.Quantity
            });
            
            newResource = new AzureResource { Region = "eastus", Quantity = 1 };
        }
    }

    private void RemoveResource(AzureResource resource)
    {
        resources.Remove(resource);
    }

    private void LoadExampleResources()
    {
        resources.Clear();
        resources.AddRange(new[]
        {
            new AzureResource { ServiceName = "Virtual Machines", SkuName = "Standard_D2s_v3", Region = "eastus", Quantity = 2 },
            new AzureResource { ServiceName = "Azure SQL Database", SkuName = "S3", Region = "eastus", Quantity = 1 },
            new AzureResource { ServiceName = "Storage", SkuName = "Standard_LRS", Region = "eastus", Quantity = 1 }
        });
    }

    private async Task CalculatePricing()
    {
        isLoading = true;
        errorMessage = null;
        costResult = null;

        try
        {
            var mcpServerUrl = Configuration["services:mcpserver:https:0"] ?? "https+http://mcpserver";
            
            // Get pricing data
            var pricingResponse = await HttpClient.PostAsJsonAsync($"{mcpServerUrl}/mcp/get-pricing", resources);
            
            if (!pricingResponse.IsSuccessStatusCode)
            {
                errorMessage = $"Failed to get pricing: {pricingResponse.StatusCode}";
                return;
            }
            
            var pricingResult = await pricingResponse.Content.ReadFromJsonAsync<PricingAnalysisResult>();
            
            if (pricingResult?.PricingData == null)
            {
                errorMessage = "Failed to parse pricing data";
                return;
            }
            
            // Calculate total cost
            var costResponse = await HttpClient.PostAsJsonAsync($"{mcpServerUrl}/mcp/calculate-cost", pricingResult.PricingData);
            
            if (!costResponse.IsSuccessStatusCode)
            {
                errorMessage = $"Failed to calculate cost: {costResponse.StatusCode}";
                return;
            }
            
            costResult = await costResponse.Content.ReadFromJsonAsync<CostCalculationResult>();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private class AzureResource
    {
        public string ServiceName { get; set; } = string.Empty;
        public string SkuName { get; set; } = string.Empty;
        public string Region { get; set; } = "eastus";
        public int Quantity { get; set; } = 1;
    }

    private class PricingAnalysisResult
    {
        public string Status { get; set; } = string.Empty;
        public int ResourceCount { get; set; }
        public List<ResourcePricing> PricingData { get; set; } = new();
    }

    private class ResourcePricing
    {
        public string ResourceName { get; set; } = string.Empty;
        public string ServiceName { get; set; } = string.Empty;
        public string SkuName { get; set; } = string.Empty;
        public string Region { get; set; } = string.Empty;
        public int Quantity { get; set; }
        public decimal HourlyCost { get; set; }
        public decimal MonthlyCost { get; set; }
        public decimal YearlyCost { get; set; }
        public string CurrencyCode { get; set; } = "USD";
        public string? Error { get; set; }
    }

    private class CostCalculationResult
    {
        public string Status { get; set; } = string.Empty;
        public string Currency { get; set; } = "USD";
        public CostSummary Summary { get; set; } = new();
        public List<ResourceCostBreakdown> Breakdown { get; set; } = new();
        public List<string> Notes { get; set; } = new();
    }

    private class CostSummary
    {
        public decimal TotalHourlyCost { get; set; }
        public decimal TotalMonthlyCost { get; set; }
        public decimal TotalYearlyCost { get; set; }
    }

    private class ResourceCostBreakdown
    {
        public string Resource { get; set; } = string.Empty;
        public int Quantity { get; set; }
        public decimal HourlyCost { get; set; }
        public decimal MonthlyCost { get; set; }
        public decimal YearlyCost { get; set; }
        public string Currency { get; set; } = "USD";
        public string? Error { get; set; }
    }
}
